---
title: "NewDoc331"
authors: "Kaatje Matthews, Alex Tran, Jena Weitzman, Alie Hall"
format: html
editor: source
code-fold: true
embed-resources: true
execute: 
  error: true
  echo: true
  message: false
  warning: false
---

## Import Data

```{r setup}
#| include: false
library(tidyverse)
library(rlang)
library(gganimate)
library(gifski)
gdp <- read_csv(file = "gdp_pcap.csv")
energy <- read_csv(file = "energy_use_per_person.csv")
```

## Helper Function

```{r}

data_cleaning <- function(og_data, new_data, variables, names, values){
  
  new_data <- og_data |>
    select(country, {{ variables }}) |>
    pivot_longer(cols = {{ variables }},
                 names_to = {{ names }},
                 values_to = {{ values }})
  
  return(new_data)
  
}

k_to_val <- function(data, variable){
  
  data <- data |>
    mutate(across(.cols = {{ variable }},
                  .fns = ~ ifelse(str_detect(string = .x,
                                             pattern = "k|K"),
                                  1000*as.numeric(str_remove_all(string = .x,
                                                                 pattern = "k|K")),
                                  as.numeric(.x)
                                  )))
  
  return(data)
  
}
```

## Apply Functions

```{r}

energy_long <- data_cleaning(og_data = energy,
                             new_data = energy_long,
                             variables = `1975`:`2013`,
                             names = "year",
                             values = "energy_use")

energy_long <- k_to_val(data = energy_long,
                        variable = "energy_use")

gdp_long <- data_cleaning(og_data = gdp,
                          new_data = gdp_long,
                          variables = `1975`:`2013`,
                          names = "year",
                          values = "gdp")

gdp_long <- k_to_val(data = gdp_long,
                          variable = "gdp")

final_data <- inner_join(energy_long,
                         gdp_long, 
                         by = join_by(country, year))

```

## Introduction

### Data and Variable Description

#### Data set #1: GDP Per Capita

The data set gdp_pcap.csv records the GDP per capita for various countries in a given year, or the value of everything produced in a country each year, divided by the country's population.This particular data sets records the GDP per capita of 195 countries in each year from 1800 to 2023, as well as the predicted GDP per capita in each year from 2024 until 2100. Gapminder labels the units of measurement for GDP per capita as constant PPP (Purchasing Power Parity) dollars. There are 195 rows in this data set, each one representing a different country, and 302 columns, each one representing a different year.

#### Data set #2: Energy Use per Person

The dataset energy_use_per_person.csv records the energy use per person in various countries, for each year from 1960 to 2015. In this case, energy use per person is referring to the use of primary energy before transformation to other end-use fuels. Gapminder labels the units of measurement for energy use per person as kg of oil equivalent per capita. This data set has 173 rows, with each row representing a different country, and 57 columns, with each column representing a different year.

### Hypothesized Relationship
We are setting our explanatory variable to be GDP per capita, and our response variable as energy use per person. We believe that the relationship between GDP and energy use per Person will be positively correlated, meaning that a larger GDP for a country will be associated with more energy use per person. In addition, through the years, with a rise in accessibility of sustainable energy, we believe that the overall trend of energy use per person will be positive. Furthermore, the rise of globalization has increased GDPs over time, leading to another positive trend.

### Data cleaning process and decision making

Since each year in both of the data sets was its own separate column, making the data very difficult to analyze, we decided to pivot the data from wide to long format. This way, we could see each year as its own observation, rather than the ugly columns that they were in before. We also decided that in the gdp per capita data set, we wanted to get rid of any years that were not consistent with the years recorded in the energy use per person data set, so we made the decision to delete any data recorded before 1960, as well as anything after 2015. Additionally, the observations in the gdp per capita data set were not consistent. Some of the observations were number values, and some of them had abbreviations using character variables. For example, some of the observations said "4k" to represent a GDP of \$4,000, so in order to make the data consistent for the purpose of analyzing, we used a string replace function to replace all instances of the letter "k" with "000", to represent one thousand numerically.

### Linear Regression

In our linear regression, we have defined GDP per capita as our explanatory variable, and energy use per person as our response variable. To observe the relationship between the two, we averaged the data points over years for each country and created a scatter plot with average GDP in the x-axis and average energy use in the y-axis.

```{r}
#Averaged values across the years
averaged_data <- final_data |>
  group_by(country) |>
  summarise(avg_energy = mean(energy_use),
            avg_gdp = mean(gdp))

averaged_data |>
  ggplot(aes(x=avg_gdp, 
             y=avg_energy)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(
    title = "GDP Per Capita Vs. Energy Use Per Person",
    subtitle = "Average Energy Use",
    x = "Average GDP",
    y = NULL
  )

```
This scatter plot with a line fitted to it suggests that there is a positive relationship between the two, insinuating that, as GDP increases, energy use increases and that countries with a greater GDP may have a higher energy use per person.

To further explore the relationship between the two, we decided to create a GIF comparing GDP per capita and energy use across the different years of interest.

```{r}
gif <- final_data |>
  mutate(year = as.integer(year)) |>
  ggplot(aes(x=gdp, 
             y=energy_use)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(title = 'GDP Per Capita Vs. Energy Use per Person by Year',
       subtitle = 'Year: {frame_time}',
       x = 'GDP per capita',
       y = 'Energy use') +
  transition_time(year) +
  ease_aes('linear')

animate(gif, renderer = gifski_renderer(), fps = 7)
```
The GIF also shows similar patterns about the relationship between GDP per capita and energy use per person such as the positive relationship and energy use increasing as GDP increases.

## Regression Model

Next, we will fit a linear regression model in order to derive the estimated regression equation.
```{r}
energy_gdp_model <- lm(avg_gdp ~ avg_energy, 
                       data = averaged_data)
energy_gdp_model$coefficients
```
From our regression model, we can come up with an linear equation to model the predicted values of energy use with GDP per capita inputs. Put more simply, our linear regression model tells us that for every 1 unit increase in constant PPP dollars (GDP), the predicted energy use per person will increase by 5.916165 kg of oil equivalent per capita (energy use).

## Model Fit

To test how well this linear regression model, we will look at the amount of variability that can be accounted for by our model.

```{r}
energy_gdp_model |>
  broom::augment() |>
  summarize(variance_energy = var(avg_energy),
            variance_fitted = var(.fitted),
            variance_residual = var(.resid)) |>
  mutate(prop = (variance_energy + variance_fitted) / 
           (variance_energy + variance_fitted + variance_residual))
```
Based on the proportion of variability that can be accounted for by our model, ~72.4% of the total variability can be attributed to our model, which is generally a good sign that our model fits well.